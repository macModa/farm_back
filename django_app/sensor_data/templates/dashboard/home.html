{% extends 'dashboard/base.html' %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-0">
            <i class="fas fa-tachometer-alt me-2 text-primary"></i>
            Dashboard IoT
        </h1>
        <p class="text-muted mb-0">Station météo ESP32 - Bizerte, Tunisie</p>
    </div>
    <div>
        <button class="btn btn-primary" onclick="refreshData()">
            <i class="fas fa-sync-alt me-2"></i>
            Actualiser
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4" id="stats-container">
    <!-- Temperature Card -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card stat-card temperature animate__animated animate__fadeInUp">
            <div class="card-body">
                <div class="stat-number" id="temp-value">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">
                    <i class="fas fa-thermometer-half me-2"></i>
                    Température
                </div>
                <small class="d-block mt-2 opacity-75" id="temp-trend">Chargement...</small>
            </div>
        </div>
    </div>

    <!-- Air Humidity Card -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card stat-card humidity animate__animated animate__fadeInUp" style="animation-delay: 0.1s">
            <div class="card-body">
                <div class="stat-number" id="humidity-air-value">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">
                    <i class="fas fa-cloud me-2"></i>
                    Humidité Air
                </div>
                <small class="d-block mt-2 opacity-75" id="humidity-air-trend">Chargement...</small>
            </div>
        </div>
    </div>

    <!-- Soil Humidity Card -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card stat-card soil animate__animated animate__fadeInUp" style="animation-delay: 0.2s">
            <div class="card-body">
                <div class="stat-number" id="humidity-soil-value">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">
                    <i class="fas fa-seedling me-2"></i>
                    Humidité Sol
                </div>
                <small class="d-block mt-2 opacity-75" id="humidity-soil-trend">Chargement...</small>
            </div>
        </div>
    </div>

    <!-- Rain Forecast Card -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card stat-card rain animate__animated animate__fadeInUp" style="animation-delay: 0.3s">
            <div class="card-body">
                <div class="stat-number" id="rain-value">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">
                    <i class="fas fa-cloud-rain me-2"></i>
                    Pluie Prévue
                </div>
                <small class="d-block mt-2 opacity-75" id="rain-trend">Chargement...</small>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Row -->
<div class="row">
    <!-- Quick Overview Chart -->
    <div class="col-lg-8 mb-4">
        <div class="card animate__animated animate__fadeInLeft">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Évolution des Données (24h)
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="updateChart(6)">6h</button>
                    <button type="button" class="btn btn-outline-primary btn-sm active" onclick="updateChart(24)">24h</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="updateChart(168)">7j</button>
                </div>
            </div>
            <div class="card-body">
                <div class="loading-spinner" id="chart-loading">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2">Chargement des données...</p>
                </div>
                <div class="chart-container">
                    <canvas id="overview-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-4 mb-4">
        <!-- System Status -->
        <div class="card mb-4 animate__animated animate__fadeInRight">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-server me-2"></i>
                    Statut Système
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>ESP32 Capteur</span>
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Connecté
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>API Météo</span>
                    <span class="badge bg-success" id="weather-status">
                        <i class="fas fa-cloud me-1"></i>
                        En ligne
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Base de Données</span>
                    <span class="badge bg-success">
                        <i class="fas fa-database me-1"></i>
                        Opérationnelle
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Total Lectures</span>
                    <span class="badge bg-info" id="total-readings">{{ total_readings|default:"0" }}</span>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card animate__animated animate__fadeInRight" style="animation-delay: 0.2s">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Activité Récente
                </h5>
            </div>
            <div class="card-body">
                <div id="recent-activity">
                    <div class="text-center p-3">
                        <i class="fas fa-spinner fa-spin text-muted"></i>
                        <p class="text-muted mt-2">Chargement...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Last Update Info -->
<div class="row">
    <div class="col-12">
        <div class="card animate__animated animate__fadeInUp" style="animation-delay: 0.4s">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-0">
                            <i class="fas fa-clock me-2 text-primary"></i>
                            Dernière mise à jour
                        </h6>
                        <span class="text-muted" id="last-update">Chargement...</span>
                    </div>
                    <div class="col-md-6 text-md-end mt-2 mt-md-0">
                        <small class="text-muted">
                            Prochaine lecture dans <span id="next-reading-countdown">30s</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let overviewChart = null;
let countdownInterval = null;
let refreshInterval = null;

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    setupAutoRefresh();
    startCountdown();
});

async function initializeDashboard() {
    await Promise.all([
        loadRealtimeData(),
        loadChartData(24),
        loadRecentActivity()
    ]);
}

async function loadRealtimeData() {
    try {
        const data = await fetchData('/dashboard/api/realtime/');
        
        if (data && data.status === 'success' && data.data) {
            const reading = data.data;
            
            // Mise à jour des cartes statistiques
            document.getElementById('temp-value').innerHTML = `${reading.temperature}°C`;
            document.getElementById('humidity-air-value').innerHTML = `${reading.humidity_air}%`;
            document.getElementById('humidity-soil-value').innerHTML = `${reading.humidity_soil}%`;
            document.getElementById('rain-value').innerHTML = `${reading.rain_forecast}mm`;
            
            // Mise à jour des tendances
            document.getElementById('temp-trend').textContent = getTrendText(reading.temperature, 'temperature');
            document.getElementById('humidity-air-trend').textContent = getTrendText(reading.humidity_air, 'humidity');
            document.getElementById('humidity-soil-trend').textContent = getTrendText(reading.humidity_soil, 'soil');
            document.getElementById('rain-trend').textContent = reading.rain_forecast > 0 ? 'Pluie prévue' : 'Temps sec';
            
            // Dernière mise à jour
            document.getElementById('last-update').textContent = reading.timestamp;
            
        } else {
            showNoDataMessage();
        }
        
        // Mise à jour des statistiques
        const stats = await fetchData('/dashboard/api/statistics/');
        if (stats && stats.data) {
            document.getElementById('total-readings').textContent = stats.data.total_readings;
        }
        
    } catch (error) {
        console.error('Erreur lors du chargement des données temps réel:', error);
        showErrorMessage();
    }
}

async function loadChartData(hours = 24) {
    try {
        document.getElementById('chart-loading').style.display = 'block';
        
        const data = await fetchData(`/dashboard/api/chart-data/?hours=${hours}`);
        
        if (data && data.status === 'success') {
            updateOverviewChart(data.data);
        }
        
        document.getElementById('chart-loading').style.display = 'none';
        
    } catch (error) {
        console.error('Erreur lors du chargement des données graphique:', error);
        document.getElementById('chart-loading').style.display = 'none';
    }
}

function updateOverviewChart(data) {
    const ctx = document.getElementById('overview-chart').getContext('2d');
    
    if (overviewChart) {
        overviewChart.destroy();
    }
    
    overviewChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [
                {
                    label: 'Température (°C)',
                    data: data.datasets.temperature,
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Humidité Air (%)',
                    data: data.datasets.humidity_air,
                    borderColor: '#4ecdc4',
                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Humidité Sol (%)',
                    data: data.datasets.humidity_soil,
                    borderColor: '#45b7d1',
                    backgroundColor: 'rgba(69, 183, 209, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Pluie (mm)',
                    data: data.datasets.rain_forecast,
                    borderColor: '#6c5ce7',
                    backgroundColor: 'rgba(108, 92, 231, 0.1)',
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Heure'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Valeurs principales'
                    },
                    min: 0
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Pluie (mm)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

async function loadRecentActivity() {
    try {
        const data = await fetchData('/dashboard/api/chart-data/?hours=6');
        const activityHtml = generateActivityList(data);
        document.getElementById('recent-activity').innerHTML = activityHtml;
    } catch (error) {
        document.getElementById('recent-activity').innerHTML = `
            <div class="text-center p-3">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                <p class="text-muted mt-2">Erreur de chargement</p>
            </div>
        `;
    }
}

function generateActivityList(data) {
    if (!data || !data.data || !data.data.labels.length) {
        return `
            <div class="text-center p-3">
                <i class="fas fa-inbox text-muted"></i>
                <p class="text-muted mt-2">Aucune donnée récente</p>
            </div>
        `;
    }
    
    const recent = data.data.labels.slice(0, 5);
    const temps = data.data.datasets.temperature.slice(0, 5);
    const humidity = data.data.datasets.humidity_soil.slice(0, 5);
    
    let html = '';
    for (let i = 0; i < recent.length; i++) {
        html += `
            <div class="d-flex align-items-center mb-2">
                <div class="me-3">
                    <i class="fas fa-circle text-primary" style="font-size: 8px;"></i>
                </div>
                <div class="flex-grow-1">
                    <small class="d-block fw-bold">${recent[i]}</small>
                    <small class="text-muted">T: ${temps[i]}°C | Sol: ${humidity[i]}%</small>
                </div>
            </div>
        `;
    }
    
    return html;
}

function getTrendText(value, type) {
    // Logique simple pour déterminer la tendance
    if (type === 'temperature') {
        if (value < 15) return 'Froid';
        if (value > 30) return 'Chaud';
        return 'Modéré';
    }
    
    if (type === 'humidity' || type === 'soil') {
        if (value < 30) return 'Sec';
        if (value > 70) return 'Humide';
        return 'Normal';
    }
    
    return 'Normale';
}

function updateChart(hours) {
    // Mise à jour des boutons actifs
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    loadChartData(hours);
}

function refreshData() {
    showToast('Actualisation des données...', 'info');
    initializeDashboard();
}

function setupAutoRefresh() {
    // Actualisation automatique toutes les 30 secondes
    refreshInterval = setInterval(() => {
        loadRealtimeData();
    }, 30000);
}

function startCountdown() {
    let seconds = 30;
    
    countdownInterval = setInterval(() => {
        seconds--;
        document.getElementById('next-reading-countdown').textContent = `${seconds}s`;
        
        if (seconds <= 0) {
            seconds = 30;
            showToast('Nouvelles données reçues', 'success');
        }
    }, 1000);
}

function showNoDataMessage() {
    ['temp-value', 'humidity-air-value', 'humidity-soil-value', 'rain-value'].forEach(id => {
        document.getElementById(id).innerHTML = '--';
    });
    
    document.getElementById('last-update').textContent = 'Aucune donnée disponible';
    showToast('Aucune donnée disponible. Vérifiez la connexion ESP32.', 'warning');
}

function showErrorMessage() {
    showToast('Erreur lors du chargement des données', 'danger');
}

// Nettoyage des intervalles lors de la fermeture de la page
window.addEventListener('beforeunload', function() {
    if (refreshInterval) clearInterval(refreshInterval);
    if (countdownInterval) clearInterval(countdownInterval);
});
</script>
{% endblock %}